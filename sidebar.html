<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      padding: 10px;
      margin: 0;
    }

    h2, h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .section {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    select, input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
      margin-top: 5px;
    }

    button:hover {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }

    #loadingContent {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    #loadingContent h3 {
      margin-top: 0;
      color: #333;
    }

    #warningMessage {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 16px;
      text-align: center;
    }

    .info-text {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: -5px;
      margin-bottom: 10px;
    }

    .checkbox-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 5px;
      background-color: white;
    }

    .checkbox-item {
      padding: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin: 0;
      flex-shrink: 0;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: normal;
      flex-grow: 1;
      cursor: pointer;
    }

    .template-link {
      display: block;
      margin: 5px 0 10px 0;
      color: #4CAF50;
      text-decoration: none;
      font-weight: bold;
      word-break: break-all;
    }

    .template-link:hover {
      text-decoration: underline;
    }

    .picker-button {
      background: transparent;
      border: none;
      color: #2196F3;
      font-size: smaller;
      margin-top: 5px;
    }

    .picker-button:hover {
      background: transparent;
      text-decoration: underline;
    }

    .icon-blank {
      margin-right: 7px;
    }

    .next-button {
      background-color: #4CAF50;
      font-weight: bold;
      padding: 12px 20px;
      font-size: 15px;
    }

    .next-button:hover {
      background-color: #45a049;
    }

    #tagMappingContainer {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      padding: 5px;
    }

    #tagMappingTable {
      margin-top: 0;
    }
</style>

</head>
<body>

  <div id="loadingOverlay">
    <div id="loadingContent">
      <div id="loadingSpinner">
        <img src="https://i.gifer.com/bfR.gif" alt="loading" style="width: 50px; height: 50px;" />
      </div>
      <h3 id="loadingTitle">Processant...</h3>
    </div>
  </div>

  <div id="warningMessage"></div>

  <h2>Gestiona informes d'avaluació</h2>

  <!-- Section 1: Sheet Selection -->
  <div class="section">
    <h3>1. Selecciona la pestanya</h3>
    <label for="sheetSelect">Pestanya:</label>
    <select id="sheetSelect">
      <option value="">--Selecciona una pestanya--</option>
    </select>
    
    <label for="headerRowIndex">#Fila de capçalera:</label>
    <input type="number" id="headerRowIndex" value="1" min="1" step="1">
    
    <button onclick="loadSheetHeaders()">Carregar capçaleres</button>
  </div>

  <!-- Section 2: Key Header Selection -->
  <div class="section" id="keyHeaderSection" style="display:none;">
    <h3>2. Selecciona la columna clau</h3>
    <p class="info-text">Tria la columna que identifica cada fila (per exemple, nom de l'alumne)</p>
    <label for="keyHeaderSelect">Columna clau:</label>
    <select id="keyHeaderSelect">
      <option value="">--Selecciona una capçalera--</option>
    </select>
    
    <button onclick="loadRowsForSelection()">Següent: Selecciona files</button>
  </div>

  <!-- Section 3: Row Selection -->
  <div class="section" id="selectRowsSection" style="display:none;">
    <h3>3. Selecciona files</h3>
    <p class="info-text">Marca les files per les quals vols generar informes</p>
    <div class="checkbox-list" id="selectRowsList">
      <table id="selectRowsTable">
        <thead id="selectRowsTableHead">
        </thead>
        <tbody id="selectRowsTableBody"></tbody>
      </table>
    </div>
    <button onclick="proceedToTemplateSetup()">Següent: Configura plantilla</button>
  </div>

  <!-- Section 4: Template and Repository Setup -->
  <div class="section" id="templateSection" style="display:none;">
    <h3>4. Configura plantilla i repositori</h3>
    
    <label>Plantilla:</label>
    <a id="TEMPLATE_ID" class="template-link" style="display:none;" href="" target="_blank" onclick="event.preventDefault(); openTemplate('TEMPLATE_ID');"></a>
    <p class="info-text" id="templatePlaceholder">Cap plantilla seleccionada</p>
    <button type="button" class="picker-button" onclick="showPicker('document')">
      <i class="fas fa-file icon-blank"></i>Selecciona
    </button>
    
    <label>Repositori:</label>
    <a id="REPOSITORY_ID" class="template-link" style="display:none;" href="" target="_blank" onclick="event.preventDefault(); openTemplate('REPOSITORY_ID');"></a>
    <p class="info-text" id="repositoryPlaceholder">Cap repositori seleccionat</p>
    <button type="button" class="picker-button" onclick="showPicker('folder')">
      <i class="fas fa-folder icon-blank"></i>Selecciona
    </button>
    
    <button id="templateNextButton" class="next-button" style="display:none;" onclick="loadTagMapping()">Següent: Mapeja tags</button>
  </div>

  <!-- Section 5: Tag Mapping -->
  <div class="section" id="tagMappingSection" style="display:none;">
    <h3>5. Mapeja tags amb capçaleres</h3>
    <p class="info-text">Associa cada tag de la plantilla amb una columna de la pestanya</p>
    <div id="tagMappingContainer">
      <table id="tagMappingTable">
        <thead>
          <tr>
            <th>Tag</th>
            <th>Capçalera</th>
          </tr>
        </thead>
        <tbody id="tagMappingTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Section 6: Execute -->
  <div class="section" id="executeSection" style="display:none;">
    <h3>6. Genera informes</h3>
    <p class="info-text">Revisa la configuració abans de generar</p>
    <div class="button-container">
      <button onclick="runSelectedRows()" style="background-color: #f44336;">
        <i class="fas fa-play"></i> Generar informes
      </button>
    </div>
  </div>

  <script>
    var availableHeaders = [];
    var selectedRows = [];

    function buildSheetSelect(data) {
      var select = document.getElementById('sheetSelect');
      data.sheets.forEach(function(sheet) {
        var option = document.createElement('option');
        option.value = sheet;
        option.text = sheet;
        if(sheet === data.selected) option.selected = true;
        select.appendChild(option);
      });
      showLoading(false);
    }

    function loadSheetHeaders() {
      var sheetName = document.getElementById('sheetSelect').value;
      var headerRowIndex = document.getElementById('headerRowIndex').value;
      
      if (!sheetName) {
        showWarning('Selecciona una pestanya primer');
        return;
      }

      showLoading(true);
      google.script.run
        .withSuccessHandler(function(headers) {
          availableHeaders = headers;
          buildKeyHeaderSelect(headers);
          document.getElementById('keyHeaderSection').style.display = 'block';
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showWarning('Error carregant capçaleres: ' + error.message);
          showLoading(false);
        })
        .carregarCapcaleres(sheetName, parseInt(headerRowIndex));
    }

    function buildKeyHeaderSelect(headers) {
      var select = document.getElementById('keyHeaderSelect');
      select.innerHTML = '<option value="">--Selecciona una capçalera--</option>';
      headers.forEach(function(header) {
        var option = document.createElement('option');
        option.value = header;
        option.text = header;
        select.appendChild(option);
      });
    }

    function loadRowsForSelection() {
      var keyHeader = document.getElementById('keyHeaderSelect').value;
      
      if (!keyHeader) {
        showWarning('Selecciona una columna clau primer');
        return;
      }

      showLoading(true);
      google.script.run
        .withSuccessHandler(function(keyValues) {
          displayRowSelection(keyValues, keyHeader);
          document.getElementById('selectRowsSection').style.display = 'block';
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          showWarning('Error carregant files: ' + error.message);
          showLoading(false);
        })
        .carregarDadesPestanya(keyHeader);
    }

    function displayRowSelection(keyValues, keyHeader) {
      var thead = document.getElementById('selectRowsTableHead');
      var tbody = document.getElementById('selectRowsTableBody');
      
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Add header row with select all checkbox
      var headerRow = document.createElement('tr');
      var selectAllCheckbox = '<input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">';
      headerRow.innerHTML = '<th>' + keyHeader + '</th><th>' + selectAllCheckbox + '</th>';
      thead.appendChild(headerRow);

      // Add data rows
      keyValues.forEach(function(fila, index) {
        var row = document.createElement('tr');
        var checkbox = '<input type="checkbox" class="rowCheckbox" id="select' + index + '">';
        row.innerHTML = '<td>' + fila[keyHeader] + '</td><td>' + checkbox + '</td>';
        tbody.appendChild(row);
      });
    }

    function toggleSelectAll(selectAllCheckbox) {
      var checkboxes = document.querySelectorAll('.rowCheckbox');
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = selectAllCheckbox.checked;
      });
    }

    function proceedToTemplateSetup() {
      // Count selected rows
      var selectedCount = 0;
      var checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      selectedCount = checkboxes.length;
      
      if (selectedCount === 0) {
        showWarning('Selecciona almenys una fila');
        return;
      }

      // Show template section
      document.getElementById('templateSection').style.display = 'block';
      
      // Try to load existing template and repository
      templateSetup('TEMPLATE_ID');
      templateSetup('REPOSITORY_ID');
    }

    function templateSetup(prop) {
      google.script.run.withSuccessHandler(function(fileData) {
        if(fileData !== 'undefined') {
          var data = JSON.parse(fileData);
          var linkElement = document.getElementById(data.prop);
          var placeholderElement = document.getElementById(prop === 'TEMPLATE_ID' ? 'templatePlaceholder' : 'repositoryPlaceholder');
          
          linkElement.innerHTML = data.name;
          linkElement.style.display = 'inline-block';
          linkElement.href = data.url;
          
          if (placeholderElement) {
            placeholderElement.style.display = 'none';
          }
          
          // Check if both template and repository are set
          checkIfReadyForTagMapping();
        }
      }).getTemplateName(prop);
    }

    function checkIfReadyForTagMapping() {
      var templateLink = document.getElementById('TEMPLATE_ID');
      var repositoryLink = document.getElementById('REPOSITORY_ID');
      
      if (templateLink.style.display !== 'none' && repositoryLink.style.display !== 'none') {
        document.getElementById('templateNextButton').style.display = 'block';
      }
    }

    function openTemplate(prop) {
      var url = document.getElementById(prop).href;
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    function loadTagMapping() {
      google.script.run.withSuccessHandler(function(templateId) {
        if(templateId !== 'undefined') {
          var selectedSheet = document.getElementById('sheetSelect').value;
          if (selectedSheet) {
            google.script.run.showSheet(selectedSheet);
            
            showLoading(true);
            document.getElementById('tagMappingSection').style.display = 'block';
            document.getElementById('executeSection').style.display = 'block';
            
            const headerRowIndex = document.getElementById('headerRowIndex').value;
            google.script.run
              .withSuccessHandler(renderTagMapping)
              .carregarCapcaleres(selectedSheet, headerRowIndex);
            google.script.run.ownMergeSetup(selectedSheet);
          }
        } else {
          showWarning('Selecciona una plantilla primer');
        }
      }).getTemplateId('TEMPLATE_ID');
    }

    function renderTagMapping(capcaleres) {
      var tbody = document.getElementById('tagMappingTableBody');
      tbody.innerHTML = '';

      google.script.run.withSuccessHandler(function(tags) {
        tags.forEach(function(tag, index) {
          var row = document.createElement('tr');
          
          var tagCell = document.createElement('td');
          tagCell.textContent = tag;
          
          var selectCell = document.createElement('td');
          var select = document.createElement('select');
          select.id = 'capcalera' + index;
          
          var defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.text = '--';
          select.appendChild(defaultOption);
          
          capcaleres.forEach(function(capcalera) {
            var option = document.createElement('option');
            option.value = capcalera;
            option.text = capcalera;
            if (tag === capcalera) {
              option.selected = true;
            }
            select.appendChild(option);
          });
          
          selectCell.appendChild(select);
          row.appendChild(tagCell);
          row.appendChild(selectCell);
          tbody.appendChild(row);
        });
        
        showLoading(false);
      }).carregarTags();
    }

    function runSelectedRows() {
      showLoading(true);
      
      var rows = document.querySelectorAll('#selectRowsTableBody tr');
      var numSelectedRows = 0;
      rows.forEach(function(row, index) {
        var checkbox = document.getElementById('select' + index);
        if (checkbox && checkbox.checked) {
          numSelectedRows++;
        }
      });

      if(numSelectedRows === 0) {
        showLoading(false);
        showWarning('No hi ha cap fila seleccionada per processar');
        return;
      }

      // Collect tag mapping
      var mapatge = [];
      var tagRows = document.querySelectorAll('#tagMappingTable tbody tr');
      tagRows.forEach(function(row, index) {
        var tag = row.cells[0].textContent;
        var capcalera = document.getElementById('capcalera' + index).value;
        if (capcalera) {
          mapatge.push({ capcalera: capcalera, tag: tag });
        }
      });

      var keyHeader = document.getElementById('keyHeaderSelect').value;
      var selectedSheet = document.getElementById('sheetSelect').value;
      var rowsProcessed = 0;

      rows.forEach(function(row, index) {
        var checkbox = document.getElementById('select' + index);
        if (checkbox && checkbox.checked) {
          var keyValue = row.cells[0].textContent;
          
          google.script.run.withSuccessHandler(function() {
            rowsProcessed++;
            if (rowsProcessed === numSelectedRows) {
              showLoading(false);
              showWarning('Informes generats correctament!', 3000);
            }
          }).mergeRow(keyValue, keyHeader, mapatge, selectedSheet);
        }
      });
    }

    var pickerApiLoaded = false;

    function showPicker(mimeType) {
      gapi.load('picker', {
        callback: function () {
          pickerApiLoaded = true;
        },
      });
      google.script.run.withSuccessHandler(function(response) {
        if(mimeType === 'document') {
          createPicker(response, google.picker.ViewId.DOCS, 'application/vnd.google-apps.document');
        } else if(mimeType === 'folder') {
          createPicker(response, google.picker.ViewId.FOLDERS, 'application/vnd.google-apps.folder');
        }
      }).withFailureHandler(showWarning).getOAuthToken();
    }

    function createPicker(token, view, mimeType) {
      if (pickerApiLoaded && token) {
        var pickerView = new google.picker.DocsView(view);
        pickerView.setMimeTypes(mimeType);
        if(mimeType === 'application/vnd.google-apps.folder') {
          pickerView.setSelectFolderEnabled(true);
        }

        var picker = new google.picker.PickerBuilder()
          .addView(pickerView)
          .enableFeature(google.picker.Feature.NAV_HIDDEN)
          .hideTitleBar()
          .setOAuthToken(token)
          .setCallback(pickerCallback)
          .setOrigin('https://docs.google.com')
          .build();

        picker.setVisible(true);
      } else {
        showWarning('Error: No es pot carregar el selector de fitxers');
      }
    }

    function pickerCallback(data) {
      var action = data[google.picker.Response.ACTION];
      if (action === google.picker.Action.PICKED) {
        var doc = data[google.picker.Response.DOCUMENTS][0];
        var id = doc[google.picker.Document.ID];
        var mimeType = doc[google.picker.Document.MIME_TYPE];
        
        if(mimeType === 'application/vnd.google-apps.folder') {
          google.script.run.withSuccessHandler(function() {
            templateSetup('REPOSITORY_ID');
          }).setTemplateId(id, 'REPOSITORY_ID');
        } else if(mimeType === 'application/vnd.google-apps.document') {
          google.script.run.withSuccessHandler(function() {
            templateSetup('TEMPLATE_ID');
          }).setTemplateId(id, 'TEMPLATE_ID');
        } else {
          showWarning('Error: Tipus de fitxer no suportat');
        }
      }
    }

    function showLoading(show) {
      var overlay = document.getElementById('loadingOverlay');
      if (show) {
        document.getElementById('loadingTitle').textContent = 'Processant...';
        overlay.style.display = 'flex';
      } else {
        overlay.style.display = 'none';
      }
    }

    function showWarning(message, timeout) {
      timeout = timeout || 3000;
      var warningElement = document.getElementById('warningMessage');
      warningElement.textContent = message;
      warningElement.style.display = 'flex';
      setTimeout(function() {
        warningElement.style.display = 'none';
      }, timeout);
    }
  </script>
  <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
</body>
</html>
